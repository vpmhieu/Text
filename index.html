<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Đọc truyện</title>
    <style>
      body {
        background-color: #0f0f0f;
        color: #bad0bd;
        max-width: 900px;
        margin: auto;
        padding: 20px;
        font-family: "Segoe UI", Roboto, Arial, sans-serif;
      }

      h2 {
        color: #b7caba;
        margin-bottom: 10px;
      }

      #content {
        background-color: #161616;
        border-radius: 8px;
        padding: 30px;
        white-space: pre-wrap;
        line-height: 2.6;
        font-size: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
      }

      button {
        background-color: #222;
        color: #fff;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 10px 18px;
        margin-top: 20px;
        cursor: pointer;
        font-size: 16px;
      }

      button:hover {
        background-color: #333;
      }

      button:active {
        background-color: #555;
      }
      html {
        font-size: 16px;
      }

      #content {
        font-size: 1.4rem; /* ~22px */
        line-height: 1.9;
      }

      @media (max-width: 768px) {
        html {
          font-size: 18px;
        }

        #content {
          font-size: 1.6rem; /* ~29px */
          line-height: 2.2;
        }
      }

      @media (max-width: 480px) {
        html {
          font-size: 19px;
        }

        #content {
          font-size: 1.7rem; /* ~32px */
        }
      }
    </style>
  </head>
  <body>
    <h2 id="title"></h2>

    <div id="content">Đang tải...</div>

    <button id="nextBtn">Kế tiếp</button>

    <script>
      const params = new URLSearchParams(window.location.search);

      let tentruyen = params.get("tentruyen") || "khauvantiendao";
      let folder = parseInt(params.get("folder")) || 1;
      let chapter = parseInt(params.get("chapter")) || 1;
      let sochuong = params.get("sochuong") === "1"; // true / false

      const contentEl = document.getElementById("content");
      const titleEl = document.getElementById("title");

      function normalizeFile(n) {
        return n % 100 === 0 ? 0 : n;
      }

      async function loadSingle(folder, file) {
        const path = `truyenfree/${tentruyen}/${folder}/${file}.txt`;
        const res = await fetch(path);
        if (!res.ok) throw new Error("404");
        return res.text();
      }

      async function loadContent() {
        contentEl.innerText = "Đang tải...";

        try {
          let text = "";

          if (!sochuong) {
            // ===== CHẾ ĐỘ CŨ: 1 FILE =====
            const file = normalizeFile(chapter);
            text = await loadSingle(folder, file);
          } else {
            // ===== CHẾ ĐỘ 4 FILE =====
            const startIndex = (chapter - 1) * 4 + 1;

            for (let i = 0; i < 4; i++) {
              const rawIndex = startIndex + i;
              const file = normalizeFile(rawIndex);

              const t = await loadSingle(folder, file);
              text += `\n\n${t}`;
            }
          }

          titleEl.innerText =
            `Truyện: ${tentruyen} – Chương ${folder} – Tập ${chapter}` +
            (sochuong ? " (4 tập)" : "");

          contentEl.innerText = text.trim();
          updateURL();
        } catch (e) {
          contentEl.innerText = "❌ Không tìm thấy nội dung";
        }
      }

      function updateURL() {
        let url = `?tentruyen=${tentruyen}&folder=${folder}&chapter=${chapter}`;
        if (sochuong) url += "&sochuong=1";

        history.replaceState({}, "", url);
      }

      function nextPage() {
        if (!sochuong) {
          // ===== MODE 1 FILE =====
          if (chapter >= 1 && chapter <= 98) chapter++;
          else if (chapter === 99) chapter = 0;
          else {
            folder++;
            chapter = 1;
          }
        } else {
          // ===== MODE 4 FILE =====
          const startIndex = (chapter - 1) * 4 + 1;
          const nextStart = startIndex + 4;

          if (nextStart > 100) {
            folder++;
            chapter = 1;
          } else {
            chapter++;
          }
        }

        loadContent();
      }

      document.getElementById("nextBtn").onclick = nextPage;

      loadContent();
    </script>
  </body>
</html>
